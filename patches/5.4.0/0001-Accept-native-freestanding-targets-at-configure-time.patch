From beed323b4736e36baa633fa75dd5799d00ad6d8a Mon Sep 17 00:00:00 2001
From: Samuel Hym <samuel@tarides.com>
Date: Mon, 26 Feb 2024 19:35:26 +0100
Subject: [PATCH 1/3] Accept native freestanding targets at configure time

Accept `*-none` and `*-elf*` triplets for all the architectures with a
native backend to describe the corresponding freestanding target; `none`
and `elf*` are the most commonly-used last components in triplets for
freestanding targets
Set `system` to `none` and `os_type` to `None` in such cases
---
 configure    | Bin 737974 -> 738675 bytes
 configure.ac |  18 ++++++++++++++++--
 2 files changed, 16 insertions(+), 2 deletions(-)

diff --git a/configure b/configure
index 8bb7306cb1..4c54453646 100755
--- a/configure
+++ b/configure
@@ -15816,6 +15816,8 @@ esac
  ;; #(
   gcc-*,powerpc-*-linux*) :
     oc_ldflags="-mbss-plt" ;; #(
+  *,*-*-none|*,*-*-elf*) :
+    ostype="None" ;; #(
   *) :
      ;;
 esac
@@ -18612,7 +18614,19 @@ fi ;; #(
   riscv64-*-linux*) :
     has_native_backend=yes; arch=riscv; model=riscv64; system=linux ;; #(
   x86_64-*-gnu*) :
-    has_native_backend=yes; arch=amd64; system=gnu
+    has_native_backend=yes; arch=amd64; system=gnu ;; #(
+  aarch64-*-none|arm64-*-none|aarch64-*-elf*|arm64-*-elf*) :
+    has_native_backend=yes; arch=arm64; system=none ;; #(
+  powerpc64le*-*-none|powerpc64le*-*-elf*) :
+    has_native_backend=yes; arch=power; model=ppc64le; system=none ;; #(
+  powerpc64*-*-none|powerpc64*-*-elf*) :
+    has_native_backend=yes; arch=power; model=ppc64; system=none ;; #(
+  riscv64-*-none|riscv64-*-elf*) :
+    has_native_backend=yes; arch=riscv; model=riscv64; system=none ;; #(
+  s390x*-*-none|s390x*-*-elf*) :
+    has_native_backend=yes; arch=s390x; model=z10; system=none ;; #(
+  x86_64-*-none|x86_64-*-elf*) :
+    has_native_backend=yes; arch=amd64; system=none
  ;; #(
   *) :
      ;;
diff --git a/configure.ac b/configure.ac
index 0535f404b0..0335bdf184 100644
--- a/configure.ac
+++ b/configure.ac
@@ -1175,7 +1175,9 @@ AS_CASE([$ocaml_cc_vendor,$target],
     [oc_ldflags='-brtl -bexpfull'
     AC_DEFINE([HAS_ARCH_CODE32], [1])],
   [gcc-*,powerpc-*-linux*],
-    [oc_ldflags="-mbss-plt"])
+    [oc_ldflags="-mbss-plt"],
+  [*,*-*-none|*,*-*-elf*],
+    [ostype="None"])
 
 # How to build sak
 
@@ -1609,7 +1611,19 @@ AS_CASE([$target],
   [riscv64-*-linux*],
     [has_native_backend=yes; arch=riscv; model=riscv64; system=linux],
   [x86_64-*-gnu*],
-    [has_native_backend=yes; arch=amd64; system=gnu]
+    [has_native_backend=yes; arch=amd64; system=gnu],
+  [aarch64-*-none|arm64-*-none|aarch64-*-elf*|arm64-*-elf*],
+    [has_native_backend=yes; arch=arm64; system=none],
+  [powerpc64le*-*-none|powerpc64le*-*-elf*],
+    [has_native_backend=yes; arch=power; model=ppc64le; system=none],
+  [powerpc64*-*-none|powerpc64*-*-elf*],
+    [has_native_backend=yes; arch=power; model=ppc64; system=none],
+  [riscv64-*-none|riscv64-*-elf*],
+    [has_native_backend=yes; arch=riscv; model=riscv64; system=none],
+  [s390x*-*-none|s390x*-*-elf*],
+    [has_native_backend=yes; arch=s390x; model=z10; system=none],
+  [x86_64-*-none|x86_64-*-elf*],
+    [has_native_backend=yes; arch=amd64; system=none]
 )
 
 AS_CASE([$arch],
-- 
2.51.0

