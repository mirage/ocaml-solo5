From ec3c09ba2a8e70d51413ffae650fcc101fdf96be Mon Sep 17 00:00:00 2001
From: Samuel Hym <samuel@tarides.com>
Date: Mon, 26 Feb 2024 19:35:26 +0100
Subject: [PATCH 19/21] Accept native freestanding targets at configure time

Accept `*-none` and `*-elf*` triplets for all the architectures with a
native backend to describe the corresponding freestanding target; `none`
and `elf*` are the most commonly-used last components in triplets for
freestanding targets
Set `system` to `none` and `os_type` to `None` in such cases
---
 configure    | Bin 709722 -> 710423 bytes
 configure.ac |  18 ++++++++++++++++--
 2 files changed, 16 insertions(+), 2 deletions(-)

diff --git a/configure b/configure
index d7921b8586..e4efe90505 100755
--- a/configure
+++ b/configure
@@ -16145,6 +16145,8 @@ esac
  ;; #(
   gcc-*,powerpc-*-linux*) :
     oc_ldflags="-mbss-plt" ;; #(
+  *,*-*-none|*,*-*-elf*) :
+    ostype="None" ;; #(
   *) :
      ;;
 esac
@@ -17761,7 +17763,19 @@ fi ;; #(
   x86_64-*-cygwin*) :
     has_native_backend=yes; arch=amd64; system=cygwin ;; #(
   riscv64-*-linux*) :
-    has_native_backend=yes; arch=riscv; model=riscv64; system=linux
+    has_native_backend=yes; arch=riscv; model=riscv64; system=linux ;; #(
+  aarch64-*-none|arm64-*-none|aarch64-*-elf*|arm64-*-elf*) :
+    has_native_backend=yes; arch=arm64; system=none ;; #(
+  powerpc64le*-*-none|powerpc64le*-*-elf*) :
+    has_native_backend=yes; arch=power; model=ppc64le; system=none ;; #(
+  powerpc64*-*-none|powerpc64*-*-elf*) :
+    has_native_backend=yes; arch=power; model=ppc64; system=none ;; #(
+  riscv64-*-none|riscv64-*-elf*) :
+    has_native_backend=yes; arch=riscv; model=riscv64; system=none ;; #(
+  s390x*-*-none|s390x*-*-elf*) :
+    has_native_backend=yes; arch=s390x; model=z10; system=none ;; #(
+  x86_64-*-none|x86_64-*-elf*) :
+    has_native_backend=yes; arch=amd64; system=none
  ;; #(
   *) :
      ;;
diff --git a/configure.ac b/configure.ac
index e1f2e85610..04d31b4962 100644
--- a/configure.ac
+++ b/configure.ac
@@ -1169,7 +1169,9 @@ AS_CASE([$ocaml_cc_vendor,$target],
     [oc_ldflags='-brtl -bexpfull'
     AC_DEFINE([HAS_ARCH_CODE32], [1])],
   [gcc-*,powerpc-*-linux*],
-    [oc_ldflags="-mbss-plt"])
+    [oc_ldflags="-mbss-plt"],
+  [*,*-*-none|*,*-*-elf*],
+    [ostype="None"])
 
 # Winpthreads emulation library for the MSVC port
 AC_MSG_CHECKING([for winpthreads sources])
@@ -1586,7 +1588,19 @@ AS_CASE([$target],
   [x86_64-*-cygwin*],
     [has_native_backend=yes; arch=amd64; system=cygwin],
   [riscv64-*-linux*],
-    [has_native_backend=yes; arch=riscv; model=riscv64; system=linux]
+    [has_native_backend=yes; arch=riscv; model=riscv64; system=linux],
+  [aarch64-*-none|arm64-*-none|aarch64-*-elf*|arm64-*-elf*],
+    [has_native_backend=yes; arch=arm64; system=none],
+  [powerpc64le*-*-none|powerpc64le*-*-elf*],
+    [has_native_backend=yes; arch=power; model=ppc64le; system=none],
+  [powerpc64*-*-none|powerpc64*-*-elf*],
+    [has_native_backend=yes; arch=power; model=ppc64; system=none],
+  [riscv64-*-none|riscv64-*-elf*],
+    [has_native_backend=yes; arch=riscv; model=riscv64; system=none],
+  [s390x*-*-none|s390x*-*-elf*],
+    [has_native_backend=yes; arch=s390x; model=z10; system=none],
+  [x86_64-*-none|x86_64-*-elf*],
+    [has_native_backend=yes; arch=amd64; system=none]
 )
 
 AS_CASE([$arch],
-- 
2.47.2

