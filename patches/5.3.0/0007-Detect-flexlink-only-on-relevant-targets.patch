From eda4278b853186db65dc80acb9e3633ce14c8f9c Mon Sep 17 00:00:00 2001
From: Samuel Hym <samuel@tarides.com>
Date: Thu, 3 Oct 2024 11:47:16 +0200
Subject: [PATCH 07/21] Detect `flexlink` only on relevant targets

On Unix platforms, make sure it is possible to have a `flexlink`
executable in `PATH` (which is useful for instance when using a cross
compiler to Windows), and still be able to configure and build a
non-cross compiler
---
 configure    | Bin 704961 -> 705055 bytes
 configure.ac |   4 +++-
 2 files changed, 3 insertions(+), 1 deletion(-)

diff --git a/configure b/configure
index 21a2617e39..8e8f2351c6 100755
--- a/configure
+++ b/configure
@@ -15649,7 +15649,9 @@ fi ;;
 esac
 fi
 
-  # Extract the first word of "flexlink", so it can be a program name with args.
+  case $target in #(
+  *-*-cygwin*|*-w64-mingw32*|*-pc-windows) :
+    # Extract the first word of "flexlink", so it can be a program name with args.
 set dummy flexlink; ac_word=$2
 { printf "%s\n" "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
 printf %s "checking for $ac_word... " >&6; }
@@ -15690,7 +15692,10 @@ else
 printf "%s\n" "no" >&6; }
 fi
 
-
+ ;; #(
+  *) :
+     ;;
+esac
 
   if test -n "$flexlink" && test -z "$flexdll_source_dir"
 then :
diff --git a/configure.ac b/configure.ac
index 9b0331cdee..ea5fa86609 100644
--- a/configure.ac
+++ b/configure.ac
@@ -1074,7 +1074,9 @@ AS_IF([test x"$supports_shared_libraries" != 'xfalse'], [
         [AC_MSG_RESULT([requested but not supported])
         AC_MSG_ERROR([exiting])])])])
 
-  AC_CHECK_PROG([flexlink],[flexlink],[flexlink])
+  AS_CASE([$target],
+    [*-*-cygwin*|*-w64-mingw32*|*-pc-windows],
+      [AC_CHECK_PROG([flexlink],[flexlink],[flexlink])])
 
   AS_IF([test -n "$flexlink" && test -z "$flexdll_source_dir"],[
     OCAML_TEST_FLEXLINK([$flexlink], [$flexdll_chain],
-- 
2.47.2

