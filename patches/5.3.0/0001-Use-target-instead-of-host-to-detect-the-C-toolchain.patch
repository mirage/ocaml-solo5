From b422dae44596575fc7b4114009ca44a026821ba5 Mon Sep 17 00:00:00 2001
From: Samuel Hym <samuel@tarides.com>
Date: Thu, 22 Feb 2024 13:37:28 +0100
Subject: [PATCH 01/21] Use `target` instead of `host` to detect the C
 toolchain

Recall that the only currently officially supported configurations are
when `build` ~ `host` = `target`, where '~' means that the code
generated for `host` runs on `build` even when they differ (such as when
`build` is `x86_64-pc-cygwin` and `host` is `x86_64-pc-windows` (MSVC)
or `x86_64-w64-mingw32`).

Still, many projects use OCaml cross compilers. All those projects
generate a cross compiler by assuming a non-cross OCaml compiler is
available in `PATH` (where non-cross means generating code that will run
on `host`). For the cross compiler, a C compiler and binutils for
`target` are necessary to build the target runtime. (Note that the
non-cross compiler will link its own (`build`/`host`) runtime into the
generated `.opt` cross compilers rather than the just-compiled target
runtime.)

In that setup the runtime that will be compiled to create a cross
compiler will run only on the `target` so this commit:

- sets `cross_compiling` by comparing `build` to `target` (rather than
  to `host`), as this variable will be used later,
- uses `target` to set up the tool prefix,
- temporarily assigns `host*` values to `target*` values during the
  libtool configuration, as this detects a `build` to `host` toolchain.

Note that all these changes are transparent when `host` = `target`.
---
 configure    | Bin 659478 -> 660523 bytes
 configure.ac |  26 ++++++++++++++++++++++++++
 2 files changed, 26 insertions(+)

diff --git a/configure b/configure
index 401b94298e..e407887556 100755
--- a/configure
+++ b/configure
@@ -3693,6 +3693,26 @@ test -n "$target_alias" &&
     NONENONEs,x,x, &&
   program_prefix=${target_alias}-
 
+# Override cross_compiling and ac_tool_prefix variables since the C toolchain is
+# used to generate target code when building a cross compiler
+cross_compiling=no
+if test x"$target_alias" != x
+then :
+  if test x"$build_alias" = x
+then :
+  cross_compiling=maybe
+else $as_nop
+  if test x"$build_alias" != x"$target_alias"
+then :
+  cross_compiling=yes
+fi
+fi
+fi
+if test -n "$target_alias"
+then :
+  ac_tool_prefix=$target_alias-
+fi
+
 # Ensure that AC_CONFIG_LINKS will either create symlinks which are compatible
 # with native Windows (i.e. NTFS symlinks, not WSL or Cygwin-emulated ones) or
 # use its fallback mechanisms. Native Windows versions of ocamlc/ocamlopt cannot
@@ -4339,14 +4359,19 @@ esac
   fi
 fi
 
+# libtool will detect a build-to-host C toolchain but when building an OCaml
+# cross compiler we need the C toolchain to build the target runtime so we
+# temporarily define host* values as macros for target* values so that the
+# proper toolchain is configured. Note that host=target unless we are building a
+# cross compiler so this is transparent for the usual use case.
 # libtool expects host_os=mingw for native Windows
 # Also, it has been observed that, on some platforms (e.g. msvc) LT_INIT
 # alters the CFLAGS variable, so we save its value before calling the macro
 # and restore it after the call
-old_host_os=$host_os
-if test x"$host_os" = "xwindows"
+old_host_os=$target_os
+if test x"$target_os" = "xwindows"
 then :
-  host_os=mingw
+  target_os=mingw
 fi
 saved_CFLAGS="$CFLAGS"
 
@@ -4551,8 +4576,8 @@ fi
   else
     case $cross_compiling:$ac_tool_warned in
 yes:)
-{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with host triplet" >&5
-printf "%s\n" "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
+{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with target triplet" >&5
+printf "%s\n" "$as_me: WARNING: using cross tools not prefixed with target triplet" >&2;}
 ac_tool_warned=yes ;;
 esac
     CC=$ac_ct_CC
@@ -4771,8 +4796,8 @@ done
   else
     case $cross_compiling:$ac_tool_warned in
 yes:)
-{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with host triplet" >&5
-printf "%s\n" "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
+{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with target triplet" >&5
+printf "%s\n" "$as_me: WARNING: using cross tools not prefixed with target triplet" >&2;}
 ac_tool_warned=yes ;;
 esac
     CC=$ac_ct_CC
@@ -4873,8 +4898,8 @@ fi
   else
     case $cross_compiling:$ac_tool_warned in
 yes:)
-{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with host triplet" >&5
-printf "%s\n" "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
+{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with target triplet" >&5
+printf "%s\n" "$as_me: WARNING: using cross tools not prefixed with target triplet" >&2;}
 ac_tool_warned=yes ;;
 esac
     CC=$ac_ct_CC
@@ -5108,7 +5133,7 @@ printf "%s\n" "$ac_try_echo"; } >&5
 	{ { printf "%s\n" "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
 printf "%s\n" "$as_me: error: in \`$ac_pwd':" >&2;}
 as_fn_error 77 "cannot run C compiled programs.
-If you meant to cross compile, use \`--host'.
+If you meant to cross compile, use \`--target'.
 See \`config.log' for more details" "$LINENO" 5; }
     fi
   fi
@@ -5776,7 +5801,7 @@ if test yes = "$GCC"; then
   # Check if gcc -print-prog-name=ld gives a path.
   { printf "%s\n" "$as_me:${as_lineno-$LINENO}: checking for ld used by $CC" >&5
 printf %s "checking for ld used by $CC... " >&6; }
-  case $host in
+  case $target in
   *-*-mingw*)
     # gcc leaves a trailing carriage return, which upsets mingw
     ac_prog=`($CC -print-prog-name=ld) 2>&5 | tr -d '\015'` ;;
@@ -5888,7 +5913,7 @@ else $as_nop
   lt_cv_path_NM=$NM
 else
   lt_nm_to_check=${ac_tool_prefix}nm
-  if test -n "$ac_tool_prefix" && test "$build" = "$host"; then
+  if test -n "$ac_tool_prefix" && test "$build" = "$target"; then
     lt_nm_to_check="$lt_nm_to_check nm"
   fi
   for lt_tmp_nm in $lt_nm_to_check; do
@@ -6043,8 +6068,8 @@ done
   else
     case $cross_compiling:$ac_tool_warned in
 yes:)
-{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with host triplet" >&5
-printf "%s\n" "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
+{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with target triplet" >&5
+printf "%s\n" "$as_me: WARNING: using cross tools not prefixed with target triplet" >&2;}
 ac_tool_warned=yes ;;
 esac
     DUMPBIN=$ac_ct_DUMPBIN
@@ -6288,13 +6313,13 @@ esac
 
 
 
-{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: checking how to convert $build file names to $host format" >&5
-printf %s "checking how to convert $build file names to $host format... " >&6; }
+{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: checking how to convert $build file names to $target format" >&5
+printf %s "checking how to convert $build file names to $target format... " >&6; }
 if test ${lt_cv_to_host_file_cmd+y}
 then :
   printf %s "(cached) " >&6
 else $as_nop
-  case $host in
+  case $target in
   *-*-mingw* )
     case $build in
       *-*-mingw* ) # actually msys
@@ -6344,7 +6369,7 @@ then :
 else $as_nop
   #assume ordinary cross tools, or native build.
 lt_cv_to_tool_file_cmd=func_convert_file_noop
-case $host in
+case $target in
   *-*-mingw* )
     case $build in
       *-*-mingw* ) # actually msys
@@ -6380,7 +6405,7 @@ case $reload_flag in
 *) reload_flag=" $reload_flag" ;;
 esac
 reload_cmds='$LD$reload_flag -o $output$reload_objs'
-case $host_os in
+case $target_os in
   cygwin* | mingw* | pw32* | cegcc*)
     if test yes != "$GCC"; then
       reload_cmds=false
@@ -6495,8 +6520,8 @@ fi
   else
     case $cross_compiling:$ac_tool_warned in
 yes:)
-{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with host triplet" >&5
-printf "%s\n" "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
+{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with target triplet" >&5
+printf "%s\n" "$as_me: WARNING: using cross tools not prefixed with target triplet" >&2;}
 ac_tool_warned=yes ;;
 esac
     OBJDUMP=$ac_ct_OBJDUMP
@@ -6535,7 +6560,7 @@ lt_cv_deplibs_check_method='unknown'
 # If you have 'file' or equivalent on your system and you're not sure
 # whether 'pass_all' will *always* work, you probably want this one.
 
-case $host_os in
+case $target_os in
 aix[4-9]*)
   lt_cv_deplibs_check_method=pass_all
   ;;
@@ -6582,7 +6607,7 @@ darwin* | rhapsody*)
 
 freebsd* | dragonfly*)
   if echo __ELF__ | $CC -E - | $GREP __ELF__ > /dev/null; then
-    case $host_cpu in
+    case $target_cpu in
     i*86 )
       # Not sure whether the presence of OpenBSD here was a mistake.
       # Let's accept both of them until this is cleared up.
@@ -6602,7 +6627,7 @@ haiku*)
 
 hpux10.20* | hpux11*)
   lt_cv_file_magic_cmd=/usr/bin/file
-  case $host_cpu in
+  case $target_cpu in
   ia64*)
     lt_cv_deplibs_check_method='file_magic (s[0-9][0-9][0-9]|ELF-[0-9][0-9]) shared object file - IA64'
     lt_cv_file_magic_test_file=/usr/lib/hpux32/libc.so
@@ -6681,7 +6706,7 @@ sysv5* | sco3.2v5* | sco5v6* | unixware* | OpenUNIX* | sysv4*uw2*)
   ;;
 
 sysv4 | sysv4.3*)
-  case $host_vendor in
+  case $target_vendor in
   motorola)
     lt_cv_deplibs_check_method='file_magic ELF [0-9][0-9]*-bit [ML]SB (shared object|dynamic lib) M[0-9][0-9]* Version [0-9]'
     lt_cv_file_magic_test_file=`echo /usr/lib/libc.so*`
@@ -6721,8 +6746,8 @@ printf "%s\n" "$lt_cv_deplibs_check_method" >&6; }
 
 file_magic_glob=
 want_nocaseglob=no
-if test "$build" = "$host"; then
-  case $host_os in
+if test "$build" = "$target"; then
+  case $target_os in
   mingw* | pw32*)
     if ( shopt | grep nocaseglob ) >/dev/null 2>&1; then
       want_nocaseglob=yes
@@ -6850,8 +6875,8 @@ fi
   else
     case $cross_compiling:$ac_tool_warned in
 yes:)
-{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with host triplet" >&5
-printf "%s\n" "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
+{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with target triplet" >&5
+printf "%s\n" "$as_me: WARNING: using cross tools not prefixed with target triplet" >&2;}
 ac_tool_warned=yes ;;
 esac
     DLLTOOL=$ac_ct_DLLTOOL
@@ -6879,7 +6904,7 @@ then :
 else $as_nop
   lt_cv_sharedlib_from_linklib_cmd='unknown'
 
-case $host_os in
+case $target_os in
 cygwin* | mingw* | pw32* | cegcc*)
   # two different shell functions defined in ltmain.sh;
   # decide which one to use based on capabilities of $DLLTOOL
@@ -7013,8 +7038,8 @@ done
   else
     case $cross_compiling:$ac_tool_warned in
 yes:)
-{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with host triplet" >&5
-printf "%s\n" "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
+{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with target triplet" >&5
+printf "%s\n" "$as_me: WARNING: using cross tools not prefixed with target triplet" >&2;}
 ac_tool_warned=yes ;;
 esac
     AR=$ac_ct_AR
@@ -7186,8 +7211,8 @@ fi
   else
     case $cross_compiling:$ac_tool_warned in
 yes:)
-{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with host triplet" >&5
-printf "%s\n" "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
+{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with target triplet" >&5
+printf "%s\n" "$as_me: WARNING: using cross tools not prefixed with target triplet" >&2;}
 ac_tool_warned=yes ;;
 esac
     STRIP=$ac_ct_STRIP
@@ -7295,8 +7320,8 @@ fi
   else
     case $cross_compiling:$ac_tool_warned in
 yes:)
-{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with host triplet" >&5
-printf "%s\n" "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
+{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with target triplet" >&5
+printf "%s\n" "$as_me: WARNING: using cross tools not prefixed with target triplet" >&2;}
 ac_tool_warned=yes ;;
 esac
     RANLIB=$ac_ct_RANLIB
@@ -7318,7 +7343,7 @@ old_postinstall_cmds='chmod 644 $oldlib'
 old_postuninstall_cmds=
 
 if test -n "$RANLIB"; then
-  case $host_os in
+  case $target_os in
   bitrig* | openbsd*)
     old_postinstall_cmds="$old_postinstall_cmds~\$RANLIB -t \$tool_oldlib"
     ;;
@@ -7329,7 +7354,7 @@ if test -n "$RANLIB"; then
   old_archive_cmds="$old_archive_cmds~\$RANLIB \$tool_oldlib"
 fi
 
-case $host_os in
+case $target_os in
   darwin*)
     lock_old_archive_extraction=yes ;;
   *)
@@ -7449,7 +7474,7 @@ symcode='[BCDEGRST]'
 sympat='\([_A-Za-z][_A-Za-z0-9]*\)'
 
 # Define system-specific variables.
-case $host_os in
+case $target_os in
 aix*)
   symcode='[BCDT]'
   ;;
@@ -7457,7 +7482,7 @@ cygwin* | mingw* | pw32* | cegcc*)
   symcode='[ABCDGISTW]'
   ;;
 hpux*)
-  if test ia64 = "$host_cpu"; then
+  if test ia64 = "$target_cpu"; then
     symcode='[ABCDEGRST]'
   fi
   ;;
@@ -7872,7 +7897,7 @@ func_cc_basename ()
         *) break;;
       esac
     done
-    func_cc_basename_result=`$ECHO "$cc_temp" | $SED "s%.*/%%; s%^$host_alias-%%"`
+    func_cc_basename_result=`$ECHO "$cc_temp" | $SED "s%.*/%%; s%^$target_alias-%%"`
 }
 
 # Check whether --enable-libtool-lock was given.
@@ -7885,7 +7910,7 @@ test no = "$enable_libtool_lock" || enable_libtool_lock=yes
 
 # Some flags need to be propagated to the compiler or linker for good
 # libtool support.
-case $host in
+case $target in
 ia64-*-hpux*)
   # Find out what ABI is being produced by ac_compile, and set mode
   # options accordingly.
@@ -7996,7 +8021,7 @@ s390*-*linux*|s390*-*tpf*|sparc*-*linux*)
   test $ac_status = 0; }; then
     case `/usr/bin/file conftest.o` in
       *32-bit*)
-	case $host in
+	case $target in
 	  x86_64-*kfreebsd*-gnu)
 	    LD="${LD-ld} -m elf_i386_fbsd"
 	    ;;
@@ -8025,7 +8050,7 @@ s390*-*linux*|s390*-*tpf*|sparc*-*linux*)
 	esac
 	;;
       *64-bit*)
-	case $host in
+	case $target in
 	  x86_64-*kfreebsd*-gnu)
 	    LD="${LD-ld} -m elf_x86_64_fbsd"
 	    ;;
@@ -8113,7 +8138,7 @@ printf "%s\n" "$lt_cv_cc_needs_belf" >&6; }
     *64-bit*)
       case $lt_cv_prog_gnu_ld in
       yes*)
-        case $host in
+        case $target in
         i?86-*-solaris*|x86_64-*-solaris*)
           LD="${LD-ld} -m elf_x86_64"
           ;;
@@ -8233,8 +8258,8 @@ fi
   else
     case $cross_compiling:$ac_tool_warned in
 yes:)
-{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with host triplet" >&5
-printf "%s\n" "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
+{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with target triplet" >&5
+printf "%s\n" "$as_me: WARNING: using cross tools not prefixed with target triplet" >&2;}
 ac_tool_warned=yes ;;
 esac
     MANIFEST_TOOL=$ac_ct_MANIFEST_TOOL
@@ -8270,7 +8295,7 @@ fi
 
 
 
-  case $host_os in
+  case $target_os in
     rhapsody* | darwin*)
     if test -n "$ac_tool_prefix"; then
   # Extract the first word of "${ac_tool_prefix}dsymutil", so it can be a program name with args.
@@ -8364,8 +8389,8 @@ fi
   else
     case $cross_compiling:$ac_tool_warned in
 yes:)
-{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with host triplet" >&5
-printf "%s\n" "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
+{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with target triplet" >&5
+printf "%s\n" "$as_me: WARNING: using cross tools not prefixed with target triplet" >&2;}
 ac_tool_warned=yes ;;
 esac
     DSYMUTIL=$ac_ct_DSYMUTIL
@@ -8466,8 +8491,8 @@ fi
   else
     case $cross_compiling:$ac_tool_warned in
 yes:)
-{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with host triplet" >&5
-printf "%s\n" "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
+{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with target triplet" >&5
+printf "%s\n" "$as_me: WARNING: using cross tools not prefixed with target triplet" >&2;}
 ac_tool_warned=yes ;;
 esac
     NMEDIT=$ac_ct_NMEDIT
@@ -8568,8 +8593,8 @@ fi
   else
     case $cross_compiling:$ac_tool_warned in
 yes:)
-{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with host triplet" >&5
-printf "%s\n" "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
+{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with target triplet" >&5
+printf "%s\n" "$as_me: WARNING: using cross tools not prefixed with target triplet" >&2;}
 ac_tool_warned=yes ;;
 esac
     LIPO=$ac_ct_LIPO
@@ -8670,8 +8695,8 @@ fi
   else
     case $cross_compiling:$ac_tool_warned in
 yes:)
-{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with host triplet" >&5
-printf "%s\n" "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
+{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with target triplet" >&5
+printf "%s\n" "$as_me: WARNING: using cross tools not prefixed with target triplet" >&2;}
 ac_tool_warned=yes ;;
 esac
     OTOOL=$ac_ct_OTOOL
@@ -8772,8 +8797,8 @@ fi
   else
     case $cross_compiling:$ac_tool_warned in
 yes:)
-{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with host triplet" >&5
-printf "%s\n" "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
+{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with target triplet" >&5
+printf "%s\n" "$as_me: WARNING: using cross tools not prefixed with target triplet" >&2;}
 ac_tool_warned=yes ;;
 esac
     OTOOL64=$ac_ct_OTOOL64
@@ -8915,7 +8940,7 @@ _LT_EOF
 fi
 { printf "%s\n" "$as_me:${as_lineno-$LINENO}: result: $lt_cv_ld_force_load" >&5
 printf "%s\n" "$lt_cv_ld_force_load" >&6; }
-    case $host_os in
+    case $target_os in
     rhapsody* | darwin1.[012])
       _lt_dar_allow_undefined='$wl-undefined ${wl}suppress' ;;
     darwin1.*)
@@ -8924,7 +8949,7 @@ printf "%s\n" "$lt_cv_ld_force_load" >&6; }
       # if running on 10.5 or later, the deployment target defaults
       # to the OS version, if on x86, and 10.4, the deployment
       # target defaults to 10.4. Don't you love it?
-      case ${MACOSX_DEPLOYMENT_TARGET-10.0},$host in
+      case ${MACOSX_DEPLOYMENT_TARGET-10.0},$target in
 	10.0,*86*-darwin8*|10.0,*-darwin[91]*)
 	  _lt_dar_allow_undefined='$wl-undefined ${wl}dynamic_lookup' ;;
 	10.[012][,.]*)
@@ -9163,7 +9188,7 @@ fi
 
 
   shared_archive_member_spec=
-case $host,$enable_shared in
+case $target,$enable_shared in
 power*-*-aix[5-9]*,yes)
   { printf "%s\n" "$as_me:${as_lineno-$LINENO}: checking which variant of shared library versioning to provide" >&5
 printf %s "checking which variant of shared library versioning to provide... " >&6; }
@@ -9302,7 +9327,7 @@ printf "%s\n" "#define LT_OBJDIR \"$lt_cv_objdir/\"" >>confdefs.h
 
 
 
-case $host_os in
+case $target_os in
 aix3*)
   # AIX sometimes has problems with the GCC collect2 program.  For some
   # reason, if we set the COLLECT_NAMES environment variable, the problems
@@ -9614,10 +9639,10 @@ lt_prog_compiler_static=
     lt_prog_compiler_wl='-Wl,'
     lt_prog_compiler_static='-static'
 
-    case $host_os in
+    case $target_os in
       aix*)
       # All AIX code is PIC.
-      if test ia64 = "$host_cpu"; then
+      if test ia64 = "$target_cpu"; then
 	# AIX 5 now supports IA64 processor
 	lt_prog_compiler_static='-Bstatic'
       fi
@@ -9625,7 +9650,7 @@ lt_prog_compiler_static=
       ;;
 
     amigaos*)
-      case $host_cpu in
+      case $target_cpu in
       powerpc)
             # see comment about AmigaOS4 .so support
             lt_prog_compiler_pic='-fPIC'
@@ -9649,7 +9674,7 @@ lt_prog_compiler_static=
       # Although the cygwin gcc ignores -fPIC, still need this for old-style
       # (--disable-auto-import) libraries
       lt_prog_compiler_pic='-DDLL_EXPORT'
-      case $host_os in
+      case $target_os in
       os2*)
 	lt_prog_compiler_static='$wl-static'
 	;;
@@ -9672,7 +9697,7 @@ lt_prog_compiler_static=
       # PIC is the default for 64-bit PA HP-UX, but not for 32-bit
       # PA HP-UX.  On IA64 HP-UX, PIC is the default but the pic flag
       # sets the default TLS model and affects inlining.
-      case $host_cpu in
+      case $target_cpu in
       hppa*64*)
 	# +Z the default
 	;;
@@ -9721,10 +9746,10 @@ lt_prog_compiler_static=
     esac
   else
     # PORTME Check for flag to pass linker flags through the system compiler.
-    case $host_os in
+    case $target_os in
     aix*)
       lt_prog_compiler_wl='-Wl,'
-      if test ia64 = "$host_cpu"; then
+      if test ia64 = "$target_cpu"; then
 	# AIX 5 now supports IA64 processor
 	lt_prog_compiler_static='-Bstatic'
       else
@@ -9750,7 +9775,7 @@ lt_prog_compiler_static=
       # This hack is so that the source file can tell whether it is being
       # built for inclusion in a dll (and should export symbols for example).
       lt_prog_compiler_pic='-DDLL_EXPORT'
-      case $host_os in
+      case $target_os in
       os2*)
 	lt_prog_compiler_static='$wl-static'
 	;;
@@ -9761,7 +9786,7 @@ lt_prog_compiler_static=
       lt_prog_compiler_wl='-Wl,'
       # PIC is the default for IA64 HP-UX and 64-bit HP-UX, but
       # not for PA HP-UX.
-      case $host_cpu in
+      case $target_cpu in
       hppa*64*|ia64*)
 	# +Z the default
 	;;
@@ -9937,7 +9962,7 @@ lt_prog_compiler_static=
     esac
   fi
 
-case $host_os in
+case $target_os in
   # For platforms that do not support PIC, -DPIC is meaningless:
   *djgpp*)
     lt_prog_compiler_pic=
@@ -10252,7 +10277,7 @@ printf %s "checking whether the $compiler linker ($LD) supports shared libraries
   # Exclude shared library initialization/finalization symbols.
   extract_expsyms_cmds=
 
-  case $host_os in
+  case $target_os in
   cygwin* | mingw* | pw32* | cegcc*)
     # FIXME: the MSVC++ port hasn't been tested in a loooong time
     # When not using gcc, we currently assume that we are using
@@ -10279,7 +10304,7 @@ printf %s "checking whether the $compiler linker ($LD) supports shared libraries
   # that we're better off using the native interface for both.
   lt_use_gnu_ld_interface=no
   if test yes = "$with_gnu_ld"; then
-    case $host_os in
+    case $target_os in
       aix*)
 	# The AIX port of GNU ld has always aspired to compatibility
 	# with the native linker.  However, as the warning in the GNU ld
@@ -10327,10 +10352,10 @@ printf %s "checking whether the $compiler linker ($LD) supports shared libraries
     esac
 
     # See if GNU ld supports shared libraries.
-    case $host_os in
+    case $target_os in
     aix[3-9]*)
       # On AIX/PPC, the GNU linker is very broken
-      if test ia64 != "$host_cpu"; then
+      if test ia64 != "$target_cpu"; then
 	ld_shlibs=no
 	cat <<_LT_EOF 1>&2
 
@@ -10346,7 +10371,7 @@ _LT_EOF
       ;;
 
     amigaos*)
-      case $host_cpu in
+      case $target_cpu in
       powerpc)
             # see comment about AmigaOS4 .so support
             archive_cmds='$CC -shared $libobjs $deplibs $compiler_flags $wl-soname $wl$soname -o $lib'
@@ -10448,7 +10473,7 @@ _LT_EOF
 
     gnu* | linux* | tpf* | k*bsd*-gnu | kopensolaris*-gnu)
       tmp_diet=no
-      if test linux-dietlibc = "$host_os"; then
+      if test linux-dietlibc = "$target_os"; then
 	case $cc_basename in
 	  diet\ *) tmp_diet=yes;;	# linux-dietlibc with static linking (!diet-dyn)
 	esac
@@ -10458,7 +10483,7 @@ _LT_EOF
       then
 	tmp_addflag=' $pic_flag'
 	tmp_sharedflag='-shared'
-	case $cc_basename,$host_cpu in
+	case $cc_basename,$target_cpu in
         pgcc*)				# Portland Group C compiler
 	  whole_archive_flag_spec='$wl--whole-archive`for conv in $convenience\"\"; do test  -n \"$conv\" && new_convenience=\"$new_convenience,$conv\"; done; func_echo_all \"$new_convenience\"` $wl--no-whole-archive'
 	  tmp_addflag=' $pic_flag'
@@ -10612,7 +10637,7 @@ _LT_EOF
     fi
   else
     # PORTME fill in a description of your system's linker (not GNU ld)
-    case $host_os in
+    case $target_os in
     aix3*)
       allow_undefined_flag=unsupported
       always_export_symbols=yes
@@ -10628,7 +10653,7 @@ _LT_EOF
       ;;
 
     aix[4-9]*)
-      if test ia64 = "$host_cpu"; then
+      if test ia64 = "$target_cpu"; then
 	# On IA64, the linker does run time linking by default, so we don't
 	# have to do anything special.
 	aix_use_runtimelinking=no
@@ -10665,7 +10690,7 @@ _LT_EOF
 	#            lib.a(lib.so.V) shared, rtl:no
 	# "svr4,*"   lib.so.V(shr.o) shared, rtl:yes, for executables
 	#            lib.a           static archive
-	case $host_os in aix4.[23]|aix4.[23].*|aix[5-9]*)
+	case $target_os in aix4.[23]|aix4.[23].*|aix[5-9]*)
 	  for ld_flag in $LDFLAGS; do
 	  if (test x-brtl = "x$ld_flag" || test x-Wl,-brtl = "x$ld_flag"); then
 	    aix_use_runtimelinking=yes
@@ -10708,7 +10733,7 @@ _LT_EOF
       esac
 
       if test yes = "$GCC"; then
-	case $host_os in aix4.[012]|aix4.[012].*)
+	case $target_os in aix4.[012]|aix4.[012].*)
 	# We only want to do this on AIX 4.2 and lower, the check
 	# below for broken collect2 doesn't work under 4.3+
 	  collect2name=`$CC -print-prog-name=collect2`
@@ -10740,7 +10765,7 @@ _LT_EOF
 	shared_flag_svr4='-shared $wl-G'
       else
 	# not using gcc
-	if test ia64 = "$host_cpu"; then
+	if test ia64 = "$target_cpu"; then
 	# VisualAge C++, Version 5.5 for AIX 5L for IA-64, Beta 3 Release
 	# chokes on -Wl,-G. The following line is correct:
 	  shared_flag='-G'
@@ -10813,7 +10838,7 @@ fi
         hardcode_libdir_flag_spec='$wl-blibpath:$libdir:'"$aix_libpath"
         archive_expsym_cmds='$CC -o $output_objdir/$soname $libobjs $deplibs $wl'$no_entry_flag' $compiler_flags `if test -n "$allow_undefined_flag"; then func_echo_all "$wl$allow_undefined_flag"; else :; fi` $wl'$exp_sym_flag:\$export_symbols' '$shared_flag
       else
-	if test ia64 = "$host_cpu"; then
+	if test ia64 = "$target_cpu"; then
 	  hardcode_libdir_flag_spec='$wl-R $libdir:/usr/lib:/lib'
 	  allow_undefined_flag="-z nodefs"
 	  archive_expsym_cmds="\$CC $shared_flag"' -o $output_objdir/$soname $libobjs $deplibs '"\$wl$no_entry_flag"' $compiler_flags $wl$allow_undefined_flag '"\$wl$exp_sym_flag:\$export_symbols"
@@ -10897,7 +10922,7 @@ fi
       ;;
 
     amigaos*)
-      case $host_cpu in
+      case $target_cpu in
       powerpc)
             # see comment about AmigaOS4 .so support
             archive_cmds='$CC -shared $libobjs $deplibs $compiler_flags $wl-soname $wl$soname -o $lib'
@@ -11082,7 +11107,7 @@ fi
 
     hpux11*)
       if test yes,no = "$GCC,$with_gnu_ld"; then
-	case $host_cpu in
+	case $target_cpu in
 	hppa*64*)
 	  archive_cmds='$CC -shared $wl+h $wl$soname -o $lib $libobjs $deplibs $compiler_flags'
 	  ;;
@@ -11094,7 +11119,7 @@ fi
 	  ;;
 	esac
       else
-	case $host_cpu in
+	case $target_cpu in
 	hppa*64*)
 	  archive_cmds='$CC -b $wl+h $wl$soname -o $lib $libobjs $deplibs $compiler_flags'
 	  ;;
@@ -11150,7 +11175,7 @@ fi
 	hardcode_libdir_flag_spec='$wl+b $wl$libdir'
 	hardcode_libdir_separator=:
 
-	case $host_cpu in
+	case $target_cpu in
 	hppa*64*|ia64*)
 	  hardcode_direct=no
 	  hardcode_shlibpath_var=no
@@ -11175,8 +11200,8 @@ fi
 	# work, assume that -exports_file does not work either and
 	# implicitly export all symbols.
 	# This should be the same for all languages, so no per-tag cache variable.
-	{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: checking whether the $host_os linker accepts -exported_symbol" >&5
-printf %s "checking whether the $host_os linker accepts -exported_symbol... " >&6; }
+	{ printf "%s\n" "$as_me:${as_lineno-$LINENO}: checking whether the $target_os linker accepts -exported_symbol" >&5
+printf %s "checking whether the $target_os linker accepts -exported_symbol... " >&6; }
 if test ${lt_cv_irix_exported_symbol+y}
 then :
   printf %s "(cached) " >&6
@@ -11349,7 +11374,7 @@ printf "%s\n" "$lt_cv_irix_exported_symbol" >&6; }
       fi
       hardcode_libdir_flag_spec='-R$libdir'
       hardcode_shlibpath_var=no
-      case $host_os in
+      case $target_os in
       solaris2.[0-5] | solaris2.[0-5].*) ;;
       *)
 	# The compiler driver will combine and reorder linker options,
@@ -11367,7 +11392,7 @@ printf "%s\n" "$lt_cv_irix_exported_symbol" >&6; }
       ;;
 
     sunos4*)
-      if test sequent = "$host_vendor"; then
+      if test sequent = "$target_vendor"; then
 	# Use $CC to link under sequent, because it throws in some extra .o
 	# files that make .init and .fini sections work.
 	archive_cmds='$CC -G $wl-h $soname -o $lib $libobjs $deplibs $compiler_flags'
@@ -11381,7 +11406,7 @@ printf "%s\n" "$lt_cv_irix_exported_symbol" >&6; }
       ;;
 
     sysv4)
-      case $host_vendor in
+      case $target_vendor in
 	sni)
 	  archive_cmds='$LD -G -h $soname -o $lib $libobjs $deplibs $linker_flags'
 	  hardcode_direct=yes # is this really true???
@@ -11470,8 +11495,8 @@ printf "%s\n" "$lt_cv_irix_exported_symbol" >&6; }
       ;;
     esac
 
-    if test sni = "$host_vendor"; then
-      case $host in
+    if test sni = "$target_vendor"; then
+      case $target in
       sysv4 | sysv4.2uw2* | sysv4.3* | sysv5*)
 	export_dynamic_flag_spec='$wl-Blargedynsym'
 	;;
@@ -11724,11 +11749,11 @@ esac
 printf %s "checking dynamic linker characteristics... " >&6; }
 
 if test yes = "$GCC"; then
-  case $host_os in
+  case $target_os in
     darwin*) lt_awk_arg='/^libraries:/,/LR/' ;;
     *) lt_awk_arg='/^libraries:/' ;;
   esac
-  case $host_os in
+  case $target_os in
     mingw* | cegcc*) lt_sed_strip_eq='s|=\([A-Za-z]:\)|\1|g' ;;
     *) lt_sed_strip_eq='s|=/|/|g' ;;
   esac
@@ -11786,7 +11811,7 @@ BEGIN {RS = " "; FS = "/|\n";} {
 }'`
   # AWK program above erroneously prepends '/' to C:/dos/paths
   # for these hosts.
-  case $host_os in
+  case $target_os in
     mingw* | cegcc*) lt_search_path_spec=`$ECHO "$lt_search_path_spec" |\
       $SED 's|/\([A-Za-z]:\)|\1|g'` ;;
   esac
@@ -11805,7 +11830,7 @@ finish_eval=
 shlibpath_var=
 shlibpath_overrides_runpath=unknown
 version_type=none
-dynamic_linker="$host_os ld.so"
+dynamic_linker="$target_os ld.so"
 sys_lib_dlsearch_path_spec="/lib /usr/lib"
 need_lib_prefix=unknown
 hardcode_into_libs=no
@@ -11816,7 +11841,7 @@ need_version=unknown
 
 
 
-case $host_os in
+case $target_os in
 aix3*)
   version_type=linux # correct to gnu/linux during the next big refactor
   library_names_spec='$libname$release$shared_ext$versuffix $libname.a'
@@ -11831,7 +11856,7 @@ aix[4-9]*)
   need_lib_prefix=no
   need_version=no
   hardcode_into_libs=yes
-  if test ia64 = "$host_cpu"; then
+  if test ia64 = "$target_cpu"; then
     # AIX 5 supports IA64
     library_names_spec='$libname$release$shared_ext$major $libname$release$shared_ext$versuffix $libname$shared_ext'
     shlibpath_var=LD_LIBRARY_PATH
@@ -11841,7 +11866,7 @@ aix[4-9]*)
     # the line '#! .'.  This would cause the generated library to
     # depend on '.', always an invalid library.  This was fixed in
     # development snapshots of GCC prior to 3.0.
-    case $host_os in
+    case $target_os in
       aix4 | aix4.[01] | aix4.[01].*)
       if { echo '#if __GNUC__ > 2 || (__GNUC__ == 2 && __GNUC_MINOR__ >= 97)'
 	   echo ' yes '
@@ -11921,7 +11946,7 @@ aix[4-9]*)
   ;;
 
 amigaos*)
-  case $host_cpu in
+  case $target_cpu in
   powerpc)
     # Since July 2007 AmigaOS4 officially supports .so libraries.
     # When compiling the executable, add -use-dynld -Lsobjs: to the compileline.
@@ -11937,7 +11962,7 @@ amigaos*)
 
 beos*)
   library_names_spec='$libname$shared_ext'
-  dynamic_linker="$host_os ld.so"
+  dynamic_linker="$target_os ld.so"
   shlibpath_var=LIBRARY_PATH
   ;;
 
@@ -11980,7 +12005,7 @@ cygwin* | mingw* | pw32* | cegcc*)
        $RM \$dlpath'
     shlibpath_overrides_runpath=yes
 
-    case $host_os in
+    case $target_os in
     cygwin*)
       # Cygwin DLLs use 'cyg' prefix rather than 'lib'
       soname_spec='`echo $libname | sed -e 's/^lib/cyg/'``echo $release | $SED -e 's/[.]/-/g'`$versuffix$shared_ext'
@@ -12066,7 +12091,7 @@ cygwin* | mingw* | pw32* | cegcc*)
   ;;
 
 darwin* | rhapsody*)
-  dynamic_linker="$host_os dyld"
+  dynamic_linker="$target_os dyld"
   version_type=darwin
   need_lib_prefix=no
   need_version=no
@@ -12095,7 +12120,7 @@ freebsd* | dragonfly*)
   if test -x /usr/bin/objformat; then
     objformat=`/usr/bin/objformat`
   else
-    case $host_os in
+    case $target_os in
     freebsd[23].*) objformat=aout ;;
     *) objformat=elf ;;
     esac
@@ -12114,7 +12139,7 @@ freebsd* | dragonfly*)
       ;;
   esac
   shlibpath_var=LD_LIBRARY_PATH
-  case $host_os in
+  case $target_os in
   freebsd2.*)
     shlibpath_overrides_runpath=yes
     ;;
@@ -12138,7 +12163,7 @@ haiku*)
   version_type=linux # correct to gnu/linux during the next big refactor
   need_lib_prefix=no
   need_version=no
-  dynamic_linker="$host_os runtime_loader"
+  dynamic_linker="$target_os runtime_loader"
   library_names_spec='$libname$release$shared_ext$versuffix $libname$release$shared_ext$major $libname$shared_ext'
   soname_spec='$libname$release$shared_ext$major'
   shlibpath_var=LIBRARY_PATH
@@ -12153,11 +12178,11 @@ hpux9* | hpux10* | hpux11*)
   version_type=sunos
   need_lib_prefix=no
   need_version=no
-  case $host_cpu in
+  case $target_cpu in
   ia64*)
     shrext_cmds='.so'
     hardcode_into_libs=yes
-    dynamic_linker="$host_os dld.so"
+    dynamic_linker="$target_os dld.so"
     shlibpath_var=LD_LIBRARY_PATH
     shlibpath_overrides_runpath=yes # Unless +noenvvar is specified.
     library_names_spec='$libname$release$shared_ext$versuffix $libname$release$shared_ext$major $libname$shared_ext'
@@ -12173,7 +12198,7 @@ hpux9* | hpux10* | hpux11*)
   hppa*64*)
     shrext_cmds='.sl'
     hardcode_into_libs=yes
-    dynamic_linker="$host_os dld.sl"
+    dynamic_linker="$target_os dld.sl"
     shlibpath_var=LD_LIBRARY_PATH # How should we handle SHLIB_PATH
     shlibpath_overrides_runpath=yes # Unless +noenvvar is specified.
     library_names_spec='$libname$release$shared_ext$versuffix $libname$release$shared_ext$major $libname$shared_ext'
@@ -12183,7 +12208,7 @@ hpux9* | hpux10* | hpux11*)
     ;;
   *)
     shrext_cmds='.sl'
-    dynamic_linker="$host_os dld.sl"
+    dynamic_linker="$target_os dld.sl"
     shlibpath_var=SHLIB_PATH
     shlibpath_overrides_runpath=no # +s is required to enable SHLIB_PATH
     library_names_spec='$libname$release$shared_ext$versuffix $libname$release$shared_ext$major $libname$shared_ext'
@@ -12209,7 +12234,7 @@ interix[3-9]*)
   ;;
 
 irix5* | irix6* | nonstopux*)
-  case $host_os in
+  case $target_os in
     nonstopux*) version_type=nonstopux ;;
     *)
 	if test yes = "$lt_cv_prog_gnu_ld"; then
@@ -12222,7 +12247,7 @@ irix5* | irix6* | nonstopux*)
   need_version=no
   soname_spec='$libname$release$shared_ext$major'
   library_names_spec='$libname$release$shared_ext$versuffix $libname$release$shared_ext$major $libname$release$shared_ext $libname$shared_ext'
-  case $host_os in
+  case $target_os in
   irix5* | nonstopux*)
     libsuff= shlibsuff=
     ;;
@@ -12482,7 +12507,7 @@ sysv4 | sysv4.3*)
   library_names_spec='$libname$release$shared_ext$versuffix $libname$release$shared_ext$major $libname$shared_ext'
   soname_spec='$libname$release$shared_ext$major'
   shlibpath_var=LD_LIBRARY_PATH
-  case $host_vendor in
+  case $target_vendor in
     sni)
       shlibpath_overrides_runpath=no
       need_lib_prefix=no
@@ -12522,7 +12547,7 @@ sysv5* | sco3.2v5* | sco5v6* | unixware* | OpenUNIX* | sysv4*uw2*)
     sys_lib_search_path_spec='/usr/local/lib /usr/gnu/lib /usr/ccs/lib /usr/lib /lib'
   else
     sys_lib_search_path_spec='/usr/ccs/lib /usr/lib'
-    case $host_os in
+    case $target_os in
       sco3.2v5*)
         sys_lib_search_path_spec="$sys_lib_search_path_spec /lib"
 	;;
@@ -12726,7 +12751,7 @@ else
   lt_cv_dlopen=no
   lt_cv_dlopen_libs=
 
-  case $host_os in
+  case $target_os in
   beos*)
     lt_cv_dlopen=load_add_on
     lt_cv_dlopen_libs=
@@ -13261,7 +13286,7 @@ if test -n "$STRIP" && $STRIP -V 2>&1 | $GREP "GNU strip" >/dev/null; then
 printf "%s\n" "yes" >&6; }
 else
 # FIXME - insert some real tests, host_os isn't really good enough
-  case $host_os in
+  case $target_os in
   darwin*)
     if test -n "$STRIP"; then
       striplib="$STRIP -x"
@@ -13303,7 +13328,7 @@ printf %s "checking whether to build shared libraries... " >&6; }
 
   # On AIX, shared libraries and static libraries use the same namespace, and
   # are all built from PIC.
-  case $host_os in
+  case $target_os in
   aix3*)
     test yes = "$enable_shared" && enable_static=no
     if test -n "$RANLIB"; then
@@ -13313,7 +13338,7 @@ printf %s "checking whether to build shared libraries... " >&6; }
     ;;
 
   aix[4-9]*)
-    if test ia64 != "$host_cpu"; then
+    if test ia64 != "$target_cpu"; then
       case $enable_shared,$with_aix_soname,$aix_use_runtimelinking in
       yes,aix,yes) ;;			# shared object as lib.so file only
       yes,svr4,*) ;;			# shared object as lib.so archive member only
@@ -13367,7 +13392,7 @@ CC=$lt_save_CC
 
 
 CFLAGS="$saved_CFLAGS"
-host_os=$old_host_os
+target_os=$old_host_os
 
 case $host in #(
   sparc-sun-solaris*) :
diff --git a/configure.ac b/configure.ac
index 64e6d7e160..18b0681d26 100644
--- a/configure.ac
+++ b/configure.ac
@@ -295,6 +295,17 @@ AC_CANONICAL_BUILD
 AC_CANONICAL_HOST
 AC_CANONICAL_TARGET
 
+# Override cross_compiling and ac_tool_prefix variables since the C toolchain is
+# used to generate target code when building a cross compiler
+cross_compiling=no
+AS_IF([test x"$target_alias" != x],
+  [AS_IF([test x"$build_alias" = x],
+    [cross_compiling=maybe],
+    [AS_IF([test x"$build_alias" != x"$target_alias"],
+      [cross_compiling=yes])])])
+AS_IF([test -n "$target_alias"],
+  [ac_tool_prefix=$target_alias-])
+
 # Ensure that AC_CONFIG_LINKS will either create symlinks which are compatible
 # with native Windows (i.e. NTFS symlinks, not WSL or Cygwin-emulated ones) or
 # use its fallback mechanisms. Native Windows versions of ocamlc/ocamlopt cannot
@@ -612,6 +623,16 @@ AS_IF([test x"$enable_ocamldoc" = "xno"],
 # Allow the MSVC linker to be found even if ld isn't installed.
 # User-specified LD still takes precedence.
 AC_CHECK_TOOLS([LD],[ld link])
+# libtool will detect a build-to-host C toolchain but when building an OCaml
+# cross compiler we need the C toolchain to build the target runtime so we
+# temporarily define host* values as macros for target* values so that the
+# proper toolchain is configured. Note that host=target unless we are building a
+# cross compiler so this is transparent for the usual use case.
+pushdef([host], target)dnl
+pushdef([host_alias], target_alias)dnl
+pushdef([host_cpu], target_cpu)dnl
+pushdef([host_vendor], target_vendor)dnl
+pushdef([host_os], target_os)dnl
 # libtool expects host_os=mingw for native Windows
 # Also, it has been observed that, on some platforms (e.g. msvc) LT_INIT
 # alters the CFLAGS variable, so we save its value before calling the macro
@@ -622,6 +643,11 @@ saved_CFLAGS="$CFLAGS"
 LT_INIT
 CFLAGS="$saved_CFLAGS"
 host_os=$old_host_os
+popdef([host_os])dnl
+popdef([host_vendor])dnl
+popdef([host_cpu])dnl
+popdef([host_alias])dnl
+popdef([host])dnl
 
 AS_CASE([$host],
   [sparc-sun-solaris*],
-- 
2.47.2

