From f7ce7cf720c530ccf533868b2fc28ba2f75eb699 Mon Sep 17 00:00:00 2001
From: Samuel Hym <samuel@tarides.com>
Date: Mon, 9 Dec 2024 19:23:40 +0100
Subject: [PATCH 05/21] Use a `TARGET_BINDIR` configure variable instead of
 `--with-target-bindir`
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Change the way to configure the location of the runtime binaries on the
target system from a `--with-target-bindir=...`, which allows users to
use a meaningless `--without-target-bindir`, to a `TARGET_BINDIR`
variable

Suggested-by: SÃ©bastien Hinderer <seb@tarides.com>
Suggested-by: David Allsopp <david.allsopp@metastack.com>
---
 configure    | Bin 704905 -> 704715 bytes
 configure.ac |  13 +++++--------
 2 files changed, 5 insertions(+), 8 deletions(-)

diff --git a/configure b/configure
index 328a177641..b9cd022989 100755
--- a/configure
+++ b/configure
@@ -772,6 +772,7 @@ ac_ct_LD
 LD
 DEFAULT_STRING
 WINDOWS_UNICODE_MODE
+TARGET_BINDIR
 LIBUNWIND_LDFLAGS
 LIBUNWIND_CPPFLAGS
 DLLIBS
@@ -1019,7 +1020,6 @@ enable_native_compiler
 enable_flambda
 enable_flambda_invariants
 enable_cmm_invariants
-with_target_bindir
 with_target_sh
 enable_reserved_header_bits
 enable_stdlib_manpages
@@ -1054,6 +1054,7 @@ COMPILER_NATIVE_CPPFLAGS
 DLLIBS
 LIBUNWIND_CPPFLAGS
 LIBUNWIND_LDFLAGS
+TARGET_BINDIR
 WINDOWS_UNICODE_MODE
 DEFAULT_STRING
 CC
@@ -1740,8 +1741,6 @@ Optional Packages:
   --with-PACKAGE[=ARG]    use PACKAGE [ARG=yes]
   --without-PACKAGE       do not use PACKAGE (same as --with-PACKAGE=no)
   --with-odoc             build documentation with odoc
-  --with-target-bindir    location of the runtime binaries on the target
-                          system
   --with-target-sh        location of Posix sh on the target system
   --with-afl              use the AFL fuzzer
   --with-flexdll          bootstrap FlexDLL from the given sources
@@ -1777,6 +1776,8 @@ Some influential environment variables:
               libunwind headers>)
   LIBUNWIND_LDFLAGS
               linker flags for libunwind (e.g. -L<location of libunwind>
+  TARGET_BINDIR
+              location of the runtime binaries on the target system
   WINDOWS_UNICODE_MODE
               how to handle Unicode under Windows: ansi, compatible
   DEFAULT_STRING
@@ -4085,14 +4086,6 @@ fi
 
 
 
-# Check whether --with-target-bindir was given.
-if test ${with_target_bindir+y}
-then :
-  withval=$with_target_bindir; target_bindir=$withval
-else $as_nop
-  target_bindir=''
-fi
-
 
 
 # Check whether --with-target-sh was given.
@@ -22677,9 +22670,9 @@ fi
   eval "exec_prefix=\"$exec_prefix\""
   eval "ocaml_bindir=\"$bindir\""
   eval "ocaml_libdir=\"$libdir\""
-  if test x"$target_bindir" = 'x'
+  if test x"$TARGET_BINDIR" = 'x'
 then :
-  target_bindir="$ocaml_bindir"
+  TARGET_BINDIR="$ocaml_bindir"
 fi
   if test x"$target_launch_method" = 'x'
 then :
@@ -23642,7 +23635,7 @@ fi
   target_launch_method=\
 '$(echo "$target_launch_method" | sed -e "s/'/'\"'\"'/g")'
   ocaml_bindir='$(echo "$ocaml_bindir" | sed -e "s/'/'\"'\"'/g")'
-  target_bindir='$(echo "$target_bindir" | sed -e "s/'/'\"'\"'/g")'
+  TARGET_BINDIR='$(echo "$TARGET_BINDIR" | sed -e "s/'/'\"'\"'/g")'
 
 _ACEOF
 
@@ -24813,7 +24806,7 @@ ltmain=$ac_aux_dir/ltmain.sh
  ;;
     "shebang":C) printf '%s\n%s\000\n' "$launch_method" "$ocaml_bindir" \
     > stdlib/runtime.info
-  printf '%s\n%s\000\n' "$target_launch_method" "$target_bindir" \
+  printf '%s\n%s\000\n' "$target_launch_method" "$TARGET_BINDIR" \
     > stdlib/target_runtime.info ;;
 
   esac
diff --git a/configure.ac b/configure.ac
index 7e3b3a054e..bb661f9f6a 100644
--- a/configure.ac
+++ b/configure.ac
@@ -519,11 +519,8 @@ AC_ARG_ENABLE([cmm-invariants],
   [AS_HELP_STRING([--enable-cmm-invariants],
     [enable invariants checks in Cmm])])
 
-AC_ARG_WITH([target-bindir],
-  [AS_HELP_STRING([--with-target-bindir],
-    [location of the runtime binaries on the target system])],
-  [target_bindir=$withval],
-  [target_bindir=''])
+AC_ARG_VAR([TARGET_BINDIR],
+  [location of the runtime binaries on the target system])
 
 AC_ARG_WITH([target-sh],
   [AS_HELP_STRING([--with-target-sh],
@@ -850,7 +847,7 @@ AS_IF([test "x$interpval" = "xyes"],
 AC_CONFIG_COMMANDS([shebang],
   [printf '%s\n%s\000\n' "$launch_method" "$ocaml_bindir" \
     > stdlib/runtime.info
-  printf '%s\n%s\000\n' "$target_launch_method" "$target_bindir" \
+  printf '%s\n%s\000\n' "$target_launch_method" "$TARGET_BINDIR" \
     > stdlib/target_runtime.info],
 dnl These declarations are put in a here-document in configure, so the command
 dnl in '$(...)' _is_ evaluated as the content is written to config.status (by
@@ -860,7 +857,7 @@ dnl nefarious single quotes which may appear in any of the strings.
   target_launch_method=\
 '$(echo "$target_launch_method" | sed -e "s/'/'\"'\"'/g")'
   ocaml_bindir='$(echo "$ocaml_bindir" | sed -e "s/'/'\"'\"'/g")'
-  target_bindir='$(echo "$target_bindir" | sed -e "s/'/'\"'\"'/g")'])
+  TARGET_BINDIR='$(echo "$TARGET_BINDIR" | sed -e "s/'/'\"'\"'/g")'])
 
 # How to build sak
 
@@ -2740,7 +2737,7 @@ AC_CONFIG_COMMANDS_PRE([
   eval "exec_prefix=\"$exec_prefix\""
   eval "ocaml_bindir=\"$bindir\""
   eval "ocaml_libdir=\"$libdir\""
-  AS_IF([test x"$target_bindir" = 'x'],[target_bindir="$ocaml_bindir"])
+  AS_IF([test x"$TARGET_BINDIR" = 'x'],[TARGET_BINDIR="$ocaml_bindir"])
   AS_IF([test x"$target_launch_method" = 'x'],
     [target_launch_method="$launch_method"])
   prefix="$saved_prefix"
-- 
2.47.2

