From 81844c1526bf09fc7faa63cb0128364e0de5c54f Mon Sep 17 00:00:00 2001
From: Samuel Hym <samuel@tarides.com>
Date: Tue, 16 Jul 2024 19:44:28 +0200
Subject: [PATCH 04/21] Check that the OCaml versions are compatible for a
 cross compiler

When building a cross compiler using an already built non-cross
compiler, check that they are of the same version as a sanity check, as
the cross compiler will be linked using the OCaml code in the source
tree and the C runtime from the non-cross compiler
---
 configure    | Bin 704188 -> 704905 bytes
 configure.ac |  11 ++++++++++-
 2 files changed, 10 insertions(+), 1 deletion(-)

diff --git a/configure b/configure
index 25fce20f50..328a177641 100755
--- a/configure
+++ b/configure
@@ -4266,7 +4266,20 @@ if test x"$host" = x"$target"
 then :
   cross_compiler=false
 else $as_nop
-  cross_compiler=true
+  # We require a non-cross compiler of the same version
+    { printf "%s\n" "$as_me:${as_lineno-$LINENO}: checking if the installed OCaml compiler can build the cross compiler" >&5
+printf %s "checking if the installed OCaml compiler can build the cross compiler... " >&6; }
+    already_installed_version="$(ocamlc -vnum)"
+    if test x"5.3.0" = x"$already_installed_version"
+then :
+  { printf "%s\n" "$as_me:${as_lineno-$LINENO}: result: yes (5.3.0)" >&5
+printf "%s\n" "yes (5.3.0)" >&6; }
+else $as_nop
+  { printf "%s\n" "$as_me:${as_lineno-$LINENO}: result: no (5.3.0 vs $already_installed_version)" >&5
+printf "%s\n" "no (5.3.0 vs $already_installed_version)" >&6; }
+      as_fn_error $? "exiting" "$LINENO" 5
+fi
+    cross_compiler=true
 fi
 
 # Initialization of libtool
diff --git a/configure.ac b/configure.ac
index f3a219ef9a..7e3b3a054e 100644
--- a/configure.ac
+++ b/configure.ac
@@ -627,7 +627,16 @@ AS_IF([test x"$enable_ocamldoc" = "xno"],
 AS_IF(
   [test x"$host" = x"$target"],
     [cross_compiler=false],
-    [cross_compiler=true])
+    [# We require a non-cross compiler of the same version
+    AC_MSG_CHECKING(m4_normalize([if the installed OCaml compiler can build the
+      cross compiler]))
+    already_installed_version="$(ocamlc -vnum)"
+    AS_IF([test x"AC_PACKAGE_VERSION" = x"$already_installed_version"],
+      [AC_MSG_RESULT([yes (AC_PACKAGE_VERSION)])],
+      [AC_MSG_RESULT(m4_normalize([no (AC_PACKAGE_VERSION vs
+        $already_installed_version)]))
+      AC_MSG_ERROR([exiting])])
+    cross_compiler=true])
 
 # Initialization of libtool
 # Allow the MSVC linker to be found even if ld isn't installed.
-- 
2.47.2

